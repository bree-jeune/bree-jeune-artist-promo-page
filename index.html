<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bree Jeune | Immersive Electronic Music</title>
  <meta name="description" content="Bree Jeune - Immersive electronic music. Deep house, R&B, and experimental sounds.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600&family=Space+Mono:wght@400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>

  </style>
</head>

<body>
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">LOADING EXPERIENCE</div>
    <div class="loading-progress" id="loadingProgress">Initializing...</div>
  </div>

  <section class="hero">
    <div class="hero-bg">
      <img src="assets/hero.jpg" alt="Bree Jeune" />
      <div class="hero-overlay"></div>
    </div>
    <div class="hero-content">
      <h1 class="hero-title">Bree Jeune</h1>
      <p class="hero-subtitle">Immersive Electronic Music</p>
      <div class="stream-buttons">
        <a href="https://open.spotify.com/artist/1r79cpT97i0D6UXZI1WyP9?si=448ds9RaQL6f_wiPKTptcQ" target="_blank"
          rel="noopener" class="stream-btn">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
          </svg>
          Spotify
        </a>
        <a href="https://music.apple.com/us/artist/bree-jeune/1865654915" target="_blank" rel="noopener"
          class="stream-btn">
          <svg viewBox="0 0 24 24">
            <path
              d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.107 1.596-.342 2.296-.792.84-.54 1.464-1.267 1.87-2.14.233-.506.376-1.04.466-1.588.13-.784.16-1.574.16-2.366V6.124z" />
          </svg>
          Apple Music
        </a>
      </div>
      <div class="social-links">
        <a href="https://www.instagram.com/bree.jeune/" target="_blank" rel="noopener" class="social-link"
          aria-label="Instagram">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z" />
          </svg>
        </a>
        <a href="https://www.facebook.com/bree.jeune" target="_blank" rel="noopener" class="social-link"
          aria-label="Facebook">
          <svg viewBox="0 0 24 24">
            <path
              d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
          </svg>
        </a>
      </div>
    </div>
    <a href="#remix" class="scroll-indicator">
      <span>Remix Experience</span>
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M19 12l-7 7-7-7" />
      </svg>
    </a>
  </section>

  <section class="remix-section" id="remix">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    <div class="container">
      <header class="remix-header">
        <p class="remix-label">REMIX EXPERIENCE</p>
        <h2 class="remix-title">Make It Yours</h2>
      </header>

      <!-- Track Selector -->
      <div class="track-selector" id="trackSelector"></div>

      <!-- Transport -->
      <div class="transport">
        <button class="play-btn" id="playBtn">
          <svg id="playIcon" viewBox="0 0 24 24">
            <polygon points="5,3 19,12 5,21" />
          </svg>
          <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none;">
            <rect x="6" y="4" width="4" height="16" rx="1" />
            <rect x="14" y="4" width="4" height="16" rx="1" />
          </svg>
        </button>
        <div class="steps" id="steps"></div>
        <div class="controls-row">
          <div class="control-group">
            <span class="control-label">BPM</span>
            <input type="range" id="bpmSlider" min="90" max="140" value="118" style="width:80px;">
            <span class="control-value" id="bpmValue">118</span>
          </div>
          <div class="control-group">
            <span class="control-label">WARMTH</span>
            <input type="range" id="warmthSlider" min="0" max="100" value="60" style="width:64px;">
          </div>
          <div class="control-group">
            <span class="control-label">REVERB</span>
            <input type="range" id="reverbSlider" min="0" max="100" value="30" style="width:64px;">
          </div>
        </div>
      </div>

      <!-- Stem Mixer -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">STEM MIXER</span>
          <a class="midi-btn" id="midiDownload" href="#" download>
            <svg viewBox="0 0 24 24">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
            </svg>
            DOWNLOAD MIDI
          </a>
        </div>
        <div id="stemMixer"></div>
      </div>

      <!-- Drum Machine Toggle -->
      <button class="drum-toggle" id="drumToggle">+ ADD YOUR OWN DRUMS</button>

      <!-- Drum Machine -->
      <div class="card" id="drumMachine" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
          <span class="card-title">DRUM MACHINE</span>
          <div class="control-group">
            <span class="control-label">VOL</span>
            <input type="range" id="drumVolume" min="0" max="100" value="60" style="width:64px;">
          </div>
        </div>
        <div id="drumGrid"></div>
        <div class="presets" id="presets"></div>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="footer-social">
      <a href="https://open.spotify.com/artist/1r79cpT97i0D6UXZI1WyP9" target="_blank" rel="noopener"
        aria-label="Spotify">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
        </svg>
      </a>
      <a href="https://music.apple.com/us/artist/bree-jeune/1865654915" target="_blank" rel="noopener"
        aria-label="Apple Music">
        <svg viewBox="0 0 24 24">
          <path
            d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.107 1.596-.342 2.296-.792.84-.54 1.464-1.267 1.87-2.14.233-.506.376-1.04.466-1.588.13-.784.16-1.574.16-2.366V6.124z" />
        </svg>
      </a>
      <a href="https://www.instagram.com/bree.jeune/" target="_blank" rel="noopener" aria-label="Instagram">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z" />
        </svg>
      </a>
      <a href="https://www.facebook.com/bree.jeune" target="_blank" rel="noopener" aria-label="Facebook">
        <svg viewBox="0 0 24 24">
          <path
            d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
        </svg>
      </a>
    </div>
    <p class="footer-copy">© 2025 BREE JEUNE • ALL RIGHTS RESERVED</p>
  </footer>

  <script>
    // 
    // TRACK CONFIGURATION
    // 
    const TRACKS = [
      {
        id: 'phantom-frequency',
        name: 'Phantom Frequency',
        bpm: 118,
        available: true,
        stems: [
          { id: 'drums', name: 'Drums', file: 'drums.mp3', volume: 0.8 },
          { id: 'bass', name: 'Bass', file: 'bass.mp3', volume: 0.8 },
          { id: 'synths', name: 'Synths', file: 'synths.mp3', volume: 0.7 },
          { id: 'guitar', name: 'Guitar', file: 'guitar.mp3', volume: 0.6 },
          { id: 'percussion', name: 'Percussion', file: 'percussion.mp3', volume: 0.6 },
          { id: 'fx', name: 'FX', file: 'fx.mp3', volume: 0.5 },
        ],
        midi: ['drums.mid', 'bass.mid', 'synths.mid', 'guitar.mid', 'percussion.mid']
      },
      {
        id: 'neon-drift',
        name: 'Neon Drift',

        bpm: 124,
        available: false,
        stems: [],
        midi: []
      },
      {
        id: 'velvet-static',
        name: 'Velvet Static',
        bpm: 110,
        available: false,
        stems: [],
        midi: []
      }
    ];

    // State
    let currentTrack = TRACKS[0];
    let isPlaying = false, currentStep = 0, bpm = 118, warmth = 60, reverbMix = 30, drumVolume = 0.6, showDrumMachine = false;
    let audioContext = null, stepInterval = null, stemsLoaded = 0, totalStems = 0;
    const audioElements = {}, stemState = {};

    const drumInstruments = [{ id: 'kick', name: 'Kick' }, { id: 'snare', name: 'Snare' }, { id: 'hihat', name: 'Hi-Hat' }, { id: 'perc', name: 'Perc' }];
    let drumPattern = { kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0], perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] };
    const presets = [
      { name: 'Deep', pattern: { kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0], perc: [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1] } },
      { name: 'Pulse', pattern: { kick: [1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0], hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0], perc: [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0] } },
      { name: 'Minimal', pattern: { kick: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0], hihat: [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1], perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },
      { name: 'Clear', pattern: { kick: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], snare: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], hihat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] } },
    ];

    // 
    // Initialization
    // 
    function init() {
      renderTrackSelector();
      renderSteps();
      renderStemMixer();
      renderDrumMachine();
      renderPresets();
      updateMidiButton();
      loadStems();
      bindEvents();
    }

    function renderTrackSelector() {
      const container = document.getElementById('trackSelector');
      container.innerHTML = '';
      TRACKS.forEach(track => {
        const card = document.createElement('div');
        card.className = 'track-card' + (track.id === currentTrack.id ? ' active' : '') + (!track.available ? ' disabled' : '');
        card.dataset.trackId = track.id;
        card.innerHTML =
          '<div class="track-icon"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>' +
          '<div class="track-name">' + track.name + '</div>' +
          '<div class="track-status">' + (track.available ? track.bpm + ' BPM' : 'Coming Soon') + '</div>' +
          (!track.available ? '<div class="coming-soon-badge">SOON</div>' : '');
        if (track.available) {
          card.onclick = () => selectTrack(track.id);
        }
        container.appendChild(card);
      });
    }

    function selectTrack(trackId) {
      if (isPlaying) togglePlay();

      // Clean up old audio
      Object.values(audioElements).forEach(a => { a.pause(); a.src = ''; });
      Object.keys(audioElements).forEach(k => delete audioElements[k]);
      Object.keys(stemState).forEach(k => delete stemState[k]);

      currentTrack = TRACKS.find(t => t.id === trackId);
      bpm = currentTrack.bpm;
      document.getElementById('bpmSlider').value = bpm;
      document.getElementById('bpmValue').textContent = bpm;

      stemsLoaded = 0;
      renderTrackSelector();
      renderStemMixer();
      updateMidiButton();
      loadStems();
    }

    function updateMidiButton() {
      const btn = document.getElementById('midiDownload');
      if (currentTrack.midi && currentTrack.midi.length > 0) {
        btn.style.display = 'inline-flex';
        btn.href = 'tracks/' + currentTrack.id + '/midi/' + currentTrack.midi[0];
        btn.onclick = (e) => {
          e.preventDefault();
          downloadAllMidi();
        };
      } else {
        btn.style.display = 'none';
      }
    }

    function downloadAllMidi() {
      currentTrack.midi.forEach((file, i) => {
        setTimeout(() => {
          const a = document.createElement('a');
          a.href = 'tracks/' + currentTrack.id + '/midi/' + file;
          a.download = file;
          a.click();
        }, i * 300);
      });
    }

    function loadStems() {
      const loadingEl = document.getElementById('loading');
      const progressEl = document.getElementById('loadingProgress');
      loadingEl.classList.remove('hidden');

      if (currentTrack.stems.length === 0) {
        progressEl.textContent = 'No stems available';
        setTimeout(() => loadingEl.classList.add('hidden'), 1000);
        return;
      }

      totalStems = currentTrack.stems.length;
      stemsLoaded = 0;

      currentTrack.stems.forEach(stem => {
        stemState[stem.id] = { volume: stem.volume, muted: false, solo: false };
        const audio = new Audio();
        audio.src = 'stems/' + stem.file;
        audio.loop = true;
        audio.preload = 'auto';

        const onReady = () => {
          stemsLoaded++;
          progressEl.textContent = stemsLoaded + ' / ' + totalStems + ' stems';
          if (stemsLoaded === totalStems) setTimeout(() => loadingEl.classList.add('hidden'), 500);
        };

        audio.addEventListener('canplaythrough', onReady, { once: true });
        audio.addEventListener('error', onReady, { once: true });
        audioElements[stem.id] = audio;
      });
    }

    function renderSteps() {
      const c = document.getElementById('steps');
      c.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const s = document.createElement('div');
        s.className = 'step' + (i % 4 === 0 ? ' beat' : '');
        c.appendChild(s);
      }
    }

    function updateSteps() {
      document.querySelectorAll('.step').forEach((s, i) => s.classList.toggle('active', i === currentStep && isPlaying));
    }

    function renderStemMixer() {
      const c = document.getElementById('stemMixer');
      c.innerHTML = '';
      if (currentTrack.stems.length === 0) {
        c.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:2rem;">Stems coming soon for this track</p>';
        return;
      }
      currentTrack.stems.forEach(stem => {
        const state = stemState[stem.id] || { volume: stem.volume, muted: false, solo: false };
        const row = document.createElement('div');
        row.className = 'stem-row';
        row.innerHTML = '<span class="stem-name">' + stem.name + '</span><div class="stem-meter" data-stem="' + stem.id + '"><div class="stem-meter-fill" style="width:' + (state.volume * 100) + '%"></div><div class="stem-bars"></div></div><input type="range" class="stem-volume" min="0" max="100" value="' + (state.volume * 100) + '" data-stem="' + stem.id + '"><button class="stem-btn ' + (state.muted ? 'muted' : '') + '" data-action="mute" data-stem="' + stem.id + '">M</button><button class="stem-btn ' + (state.solo ? 'solo' : '') + '" data-action="solo" data-stem="' + stem.id + '">S</button>';
        c.appendChild(row);
      });
    }

    function updateStemMeters() {
      currentTrack.stems.forEach(stem => {
        const state = stemState[stem.id];
        if (!state) return;
        const meter = document.querySelector('.stem-meter[data-stem="' + stem.id + '"]');
        if (!meter) return;
        const fill = meter.querySelector('.stem-meter-fill'), bars = meter.querySelector('.stem-bars');
        fill.style.width = state.muted ? '0%' : (state.volume * 100) + '%';
        fill.classList.toggle('muted', state.muted);
        fill.classList.toggle('playing', isPlaying && !state.muted);
        if (isPlaying && !state.muted) {
          bars.innerHTML = '';
          for (let i = 0; i < 20; i++) {
            const b = document.createElement('div');
            b.className = 'stem-bar';
            b.style.height = (20 + Math.random() * 60 * state.volume) + '%';
            bars.appendChild(b);
          }
        } else bars.innerHTML = '';
        const muteBtn = document.querySelector('.stem-btn[data-action="mute"][data-stem="' + stem.id + '"]');
        const soloBtn = document.querySelector('.stem-btn[data-action="solo"][data-stem="' + stem.id + '"]');
        if (muteBtn) muteBtn.classList.toggle('muted', state.muted);
        if (soloBtn) soloBtn.classList.toggle('solo', state.solo);
      });
    }

    function renderDrumMachine() {
      const c = document.getElementById('drumGrid');
      c.innerHTML = '';
      drumInstruments.forEach(inst => {
        const row = document.createElement('div');
        row.className = 'drum-row';
        let html = '';
        for (let i = 0; i < 16; i++) html += '<button class="drum-step ' + (drumPattern[inst.id][i] ? 'on' : '') + (i % 4 === 0 && i > 0 ? ' beat-marker' : '') + '" data-inst="' + inst.id + '" data-step="' + i + '"></button>';
        row.innerHTML = '<span class="drum-label">' + inst.name + '</span><div class="drum-steps">' + html + '</div>';
        c.appendChild(row);
      });
    }

    function updateDrumSteps() {
      document.querySelectorAll('.drum-step').forEach(s => s.classList.toggle('current', parseInt(s.dataset.step) === currentStep && isPlaying));
    }

    function renderPresets() {
      const c = document.getElementById('presets');
      c.innerHTML = '';
      presets.forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'preset-btn';
        btn.textContent = p.name;
        btn.onclick = () => { drumPattern = JSON.parse(JSON.stringify(p.pattern)); renderDrumMachine(); };
        c.appendChild(btn);
      });
    }

    function togglePlay() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      isPlaying = !isPlaying;
      const btn = document.getElementById('playBtn'), play = document.getElementById('playIcon'), pause = document.getElementById('pauseIcon');
      btn.classList.toggle('playing', isPlaying);
      play.style.display = isPlaying ? 'none' : 'block';
      pause.style.display = isPlaying ? 'block' : 'none';
      if (isPlaying) {
        Object.keys(audioElements).forEach(id => {
          const a = audioElements[id], s = stemState[id];
          if (a && s) { a.volume = s.muted ? 0 : s.volume; a.play().catch(() => { }); }
        });
        startSequencer();
      } else {
        Object.values(audioElements).forEach(a => a && a.pause());
        stopSequencer();
      }
      updateStemMeters();
    }

    function startSequencer() {
      stepInterval = setInterval(() => {
        currentStep = (currentStep + 1) % 16;
        updateSteps();
        updateDrumSteps();
        if (showDrumMachine) playDrumSounds();
        if (isPlaying) updateStemMeters();
      }, (60 / bpm / 4) * 1000);
    }

    function stopSequencer() {
      if (stepInterval) clearInterval(stepInterval);
      stepInterval = null;
      currentStep = 0;
      updateSteps();
      updateDrumSteps();
    }

    function updateBPM(v) {
      bpm = v;
      if (isPlaying) { stopSequencer(); startSequencer(); }
    }

    function setStemVolume(id, v) {
      stemState[id].volume = v;
      if (audioElements[id] && !stemState[id].muted) audioElements[id].volume = v;
      updateStemMeters();
    }

    function toggleMute(id) {
      stemState[id].muted = !stemState[id].muted;
      if (audioElements[id]) audioElements[id].volume = stemState[id].muted ? 0 : stemState[id].volume;
      updateStemMeters();
    }

    function toggleSolo(id) {
      if (stemState[id].solo) {
        Object.keys(stemState).forEach(i => {
          stemState[i].solo = false;
          stemState[i].muted = false;
          if (audioElements[i]) audioElements[i].volume = stemState[i].volume;
        });
      } else {
        Object.keys(stemState).forEach(i => {
          const s = i === id;
          stemState[i].solo = s;
          stemState[i].muted = !s;
          if (audioElements[i]) audioElements[i].volume = s ? stemState[i].volume : 0;
        });
      }
      updateStemMeters();
    }

    function playDrumSounds() {
      Object.keys(drumPattern).forEach(t => { if (drumPattern[t][currentStep]) playDrumSound(t); });
    }

    function playDrumSound(type) {
      if (!audioContext) return;
      const ctx = audioContext, now = ctx.currentTime, vol = drumVolume, w = warmth / 100;
      if (type === 'kick') {
        const o = ctx.createOscillator(), g = ctx.createGain(), f = ctx.createBiquadFilter();
        f.type = 'lowpass'; f.frequency.value = 200 + w * 100;
        o.connect(f); f.connect(g); g.connect(ctx.destination);
        o.frequency.setValueAtTime(120 + w * 30, now);
        o.frequency.exponentialRampToValueAtTime(0.01, now + 0.4);
        g.gain.setValueAtTime(vol, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
        o.start(now); o.stop(now + 0.4);
      } else if (type === 'snare') {
        const bs = ctx.sampleRate * 0.12, b = ctx.createBuffer(1, bs, ctx.sampleRate), d = b.getChannelData(0);
        for (let i = 0; i < bs; i++) d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.04));
        const s = ctx.createBufferSource(); s.buffer = b;
        const g = ctx.createGain(), f = ctx.createBiquadFilter();
        f.type = 'bandpass'; f.frequency.value = 1000 + w * 500;
        s.connect(f); f.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(vol * 0.35, now); s.start(now);
      } else if (type === 'hihat') {
        const bs = ctx.sampleRate * 0.04, b = ctx.createBuffer(1, bs, ctx.sampleRate), d = b.getChannelData(0);
        for (let i = 0; i < bs; i++) d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.015));
        const s = ctx.createBufferSource(); s.buffer = b;
        const f = ctx.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 7000;
        const g = ctx.createGain();
        s.connect(f); f.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(vol * 0.12, now); s.start(now);
      } else if (type === 'perc') {
        const o = ctx.createOscillator(); o.type = 'triangle';
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.frequency.setValueAtTime(800, now);
        o.frequency.exponentialRampToValueAtTime(200, now + 0.1);
        g.gain.setValueAtTime(vol * 0.2, now);
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        o.start(now); o.stop(now + 0.1);
      }
    }

    function bindEvents() {
      document.getElementById('playBtn').onclick = togglePlay;
      document.getElementById('bpmSlider').oninput = e => {
        document.getElementById('bpmValue').textContent = e.target.value;
        updateBPM(parseInt(e.target.value));
      };
      document.getElementById('warmthSlider').oninput = e => warmth = parseInt(e.target.value);
      document.getElementById('reverbSlider').oninput = e => reverbMix = parseInt(e.target.value);
      document.getElementById('stemMixer').onclick = e => {
        const b = e.target.closest('.stem-btn');
        if (!b) return;
        if (b.dataset.action === 'mute') toggleMute(b.dataset.stem);
        if (b.dataset.action === 'solo') toggleSolo(b.dataset.stem);
      };
      document.getElementById('stemMixer').oninput = e => {
        if (e.target.classList.contains('stem-volume')) {
          const id = e.target.dataset.stem, v = parseInt(e.target.value) / 100;
          setStemVolume(id, v);
          const f = document.querySelector('.stem-meter[data-stem="' + id + '"] .stem-meter-fill');
          if (f) f.style.width = (v * 100) + '%';
        }
      };
      const dt = document.getElementById('drumToggle'), dm = document.getElementById('drumMachine');
      dt.onclick = () => {
        showDrumMachine = !showDrumMachine;
        dt.classList.toggle('active', showDrumMachine);
        dt.textContent = showDrumMachine ? '▼ DRUM MACHINE' : '+ ADD YOUR OWN DRUMS';
        dm.style.display = showDrumMachine ? 'block' : 'none';
      };
      document.getElementById('drumVolume').oninput = e => drumVolume = parseInt(e.target.value) / 100;
      document.getElementById('drumGrid').onclick = e => {
        const s = e.target.closest('.drum-step');
        if (!s) return;
        drumPattern[s.dataset.inst][parseInt(s.dataset.step)] = drumPattern[s.dataset.inst][parseInt(s.dataset.step)] ? 0 : 1;
        s.classList.toggle('on');
      };
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>